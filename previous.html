<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Marathon Log V3.3 </title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #f3f4f6; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
        .card { transition: all 0.2s; }
        .card:active { transform: scale(0.98); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .action-item { transition: all 0.2s; }
        .action-item.checked { background-color: #effdf5; border-color: #86efac; }
        .action-item.checked .check-box { background-color: #22c55e; border-color: #22c55e; }
        .action-item.checked .action-name { color: #166534; text-decoration: line-through; opacity: 0.8; }
    </style>
</head>
<body class="pb-24">

    <div class="bg-blue-700 text-white p-4 sticky top-0 z-20 shadow-md">
        <div class="flex justify-between items-center mb-3">
            <h1 class="text-lg font-bold">üèÉ‚Äç‚ôÇÔ∏è V3.3 </h1>
            <div class="flex space-x-2">
                <button onclick="generateReport()" class="bg-green-500 text-xs px-3 py-1.5 rounded shadow hover:bg-green-600 font-medium">
                    üìã Copy
                </button>
                <button onclick="backupToEmail()" class="bg-gray-100 text-blue-700 text-xs px-3 py-1.5 rounded shadow hover:bg-white font-bold flex items-center">
                    üì© Email
                </button>
            </div>
        </div>
        
        <select id="week-selector" onchange="changeWeek()" class="w-full p-2 text-black rounded-lg outline-none font-bold shadow-inner bg-blue-50">
            <option value="1">Week 1: Base & Alignment (Nov 20-26)</option>
            <option value="2">Week 2: Consistency (Nov 27-Dec 03)</option>
            <option value="3">Week 3: Form Focus (Dec 04-10)</option>
            <option value="4">Week 4: Recovery (Dec 11-17)</option>
        </select>
    </div>

    <div class="px-4 pt-4">
        <div class="flex justify-between text-xs text-gray-500 mb-1">
            <span>Weekly Progress</span>
            <span id="progress-text">0/7</span>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-2.5">
            <div id="progress-bar" class="bg-blue-600 h-2.5 rounded-full transition-all duration-500" style="width: 0%"></div>
        </div>
    </div>

    <div id="schedule-list" class="p-4 space-y-3">
        </div>

    <div id="modal" class="fixed inset-0 bg-black bg-opacity-60 hidden flex items-end justify-center z-50 backdrop-blur-sm">
        <div class="bg-white w-full rounded-t-2xl p-6 h-5/6 overflow-y-auto animate-slide-up flex flex-col">
            <div class="flex justify-between items-center mb-4 flex-shrink-0">
                <h2 class="text-xl font-bold text-blue-800" id="modal-title">Edit Record</h2>
                <button onclick="closeModal()" class="text-gray-400 text-2xl">&times;</button>
            </div>
            
            <div class="space-y-5 flex-grow overflow-y-auto pb-20">
                
                <div id="action-section">
                    <label class="block text-sm font-bold text-gray-700 mb-2">üí™ Corrective Actions (Tap to Check)</label>
                    <div id="action-list" class="space-y-2">
                        </div>
                </div>

                <div class="border-t pt-4">
                    <label class="block text-sm font-bold text-gray-700 mb-1">‚úÖ Result (Dist/Time)</label>
                    <input type="text" id="input-result" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none" placeholder="e.g., 5.02km, 35min">
                </div>

                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">ü¶µ Knee Feeling (Medial/Twist)</label>
                    <textarea id="input-feeling" rows="2" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Any twisting pain?"></textarea>
                </div>

                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">üìâ Pain Level (0-10)</label>
                    <div class="flex space-x-2 overflow-x-auto py-2 no-scrollbar">
                        <script>
                            for(let i=0; i<=10; i++) {
                                document.write(`<div onclick="selectPain(${i})" id="pain-btn-${i}" class="pain-btn flex-shrink-0 w-10 h-10 rounded-full border flex items-center justify-center cursor-pointer font-bold ${i>=3 ? 'border-red-200 text-red-600' : 'border-green-200 text-green-600'}">${i}</div>`);
                            }
                        </script>
                    </div>
                    <input type="hidden" id="input-pain">
                </div>
                
                <div class="h-10"></div> </div>

            <div class="absolute bottom-0 left-0 w-full p-4 bg-white border-t border-gray-100">
                <button onclick="saveData()" class="w-full bg-blue-600 active:bg-blue-700 text-white py-3 rounded-xl font-bold text-lg shadow-lg">Save Record</button>
            </div>
        </div>
    </div>

    <script>
        // ================= DATA DEFINITION (V3.3 - Duck Feet/Out-toeing Fix) =================
        const masterPlan = [
            // Week 1
            { 
                week: 1, date: "Nov 20 (Thu)", task: "Easy Run 5km", focus: "Knee follows Toes", 
                actions: [
                    {name: "Alignment Check", desc: "If feet turn out, knee MUST bend out too. Don't buckle in.", done: false},
                    {name: "Figure-4 Stretch", desc: "Release Piriformis (Tight glutes cause duck feet)", done: false},
                    {name: "VMO Activation", desc: "10x each leg, squeeze medial quad", done: false}
                ] 
            },
            { 
                week: 1, date: "Nov 21 (Fri)", task: "Strength (Core/Upper)", focus: "Stability", 
                actions: [
                    {name: "Plank (3 x 45s)", desc: "Tight core", done: false},
                    {name: "Dead Bugs (3 x 15)", desc: "Flat back", done: false},
                    {name: "Push-ups (3 sets)", desc: "Arm power", done: false},
                    {name: "Figure-4 Stretch", desc: "Deep glute stretch, 2 min each side", done: false}
                ]
            },
            { 
                week: 1, date: "Nov 22 (Sat)", task: "Long Run 8km", focus: "Run 4 / Walk 1", 
                actions: [
                    {name: "Strict Run/Walk", desc: "Preserve the knees", done: false},
                    {name: "Watch Landing", desc: "Don't let arch collapse inward (Over-pronation)", done: false},
                    {name: "Post-Run Stretch", desc: "Figure-4 + Butterfly + Hamstrings", done: false}
                ]
            },
            { 
                week: 1, date: "Nov 23 (Sun)", task: "Power Walk + Strength", focus: "Anti-Rotation", 
                actions: [
                    {name: "Power Walk 45min", desc: "Focus on pushing off big toe", done: false},
                    {name: "Wall Sit w/ Ball (3x45s)", desc: "Crucial for VMO / Medial Knee", done: false},
                    {name: "Clamshells (3x15)", desc: "Strengthen Glute Med to fight internal rotation", done: false}
                ]
            },
            { 
                week: 1, date: "Nov 24 (Mon)", task: "Rest Day", focus: "Recovery", 
                actions: [
                    {name: "Sleep 8hr+", desc: "Muscle repair", done: false},
                    {name: "Figure-4 Stretch", desc: "Loosen hips while watching TV", done: false}
                ]
            },
            { 
                week: 1, date: "Nov 25 (Tue)", task: "Easy Run 5km", focus: "Wide Stance", 
                actions: [
                    {name: "Run 5km", desc: "Feet 10cm apart (Railroad)", done: false},
                    {name: "VMO Activation", desc: "Bedtime routine", done: false}
                ]
            },
            { 
                week: 1, date: "Nov 26 (Wed)", task: "Strength (Legs/Glutes)", focus: "Hip Control", 
                actions: [
                    {name: "Clamshells (4 x 15)", desc: "Top Priority exercise", done: false},
                    {name: "Squats (3 x 15)", desc: "Watch your knees! Push them OUT over toes", done: false},
                    {name: "Glute Bridge (3 x 15)", desc: "Squeeze butt hard", done: false},
                    {name: "Figure-4 Stretch", desc: "End the session with this", done: false}
                ]
            },
            
            // Week 2
            { week: 2, date: "Nov 27 (Thu)", task: "Easy Run 6km", focus: "Knee Tracking", actions: [{name: "Run 6km", desc: "Knee over 2nd toe", done: false}, {name: "VMO Activation", desc: "", done: false}] },
            { week: 2, date: "Nov 28 (Fri)", task: "Strength (Core)", focus: "Core", actions: [{name: "Plank", desc: "60s", done: false}, {name: "Figure-4 Stretch", desc: "Daily habit", done: false}] },
            { week: 2, date: "Nov 29 (Sat)", task: "Long Run 9km", focus: "Run 4 / Walk 1", actions: [{name: "Run 9km", desc: "Monitor medial pain", done: false}, {name: "Full Stretch", desc: "", done: false}] },
            { week: 2, date: "Nov 30 (Sun)", task: "Power Walk + VMO", focus: "Alignment", actions: [{name: "Walk 45min", desc: "", done: false}, {name: "Wall Sit w/ Ball", desc: "3x60s", done: false}] },
            { week: 2, date: "Dec 01 (Mon)", task: "Rest Day", focus: "Rest", actions: [{name: "Rest", desc: "", done: false}] },
            { week: 2, date: "Dec 02 (Tue)", task: "Easy Run 5km", focus: "Light Feet", actions: [{name: "Run 5km", desc: "Soft landing", done: false}, {name: "VMO Activation", desc: "", done: false}] },
            { week: 2, date: "Dec 03 (Wed)", task: "Strength (Legs)", focus: "Glutes", actions: [{name: "Clamshells", desc: "Add band", done: false}, {name: "Squats", desc: "Knees OUT", done: false}] },

             // Week 3
            { week: 3, date: "Dec 04 (Thu)", task: "Easy Run 6km", focus: "Breathing", actions: [{name: "Run 6km", desc: "", done: false}] },
            { week: 3, date: "Dec 05 (Fri)", task: "Strength (Core)", focus: "Stability", actions: [{name: "Dead Bugs", desc: "", done: false}, {name: "Stretch", desc: "Figure-4", done: false}] },
            { week: 3, date: "Dec 06 (Sat)", task: "Long Run 10km", focus: "Endurance", actions: [{name: "Run 10km", desc: "Double digits!", done: false}] },
            { week: 3, date: "Dec 07 (Sun)", task: "Walk + VMO", focus: "Health", actions: [{name: "Walk 50min", desc: "", done: false}, {name: "Wall Sit", desc: "", done: false}] },
            { week: 3, date: "Dec 08 (Mon)", task: "Rest Day", focus: "Recovery", actions: [{name: "Rest", desc: "", done: false}] },
            { week: 3, date: "Dec 09 (Tue)", task: "Easy Run 6km", focus: "Relax", actions: [{name: "Run 6km", desc: "", done: false}] },
            { week: 3, date: "Dec 10 (Wed)", task: "Strength (Legs)", focus: "Power", actions: [{name: "Leg Routine", desc: "", done: false}] },

            // Week 4
            { week: 4, date: "Dec 11 (Thu)", task: "Easy Run 5km", focus: "Easy", actions: [{name: "Run 5km", desc: "", done: false}] },
            { week: 4, date: "Dec 12 (Fri)", task: "Rest", focus: "Sleep", actions: [{name: "Stretch", desc: "No strength today", done: false}] },
            { week: 4, date: "Dec 13 (Sat)", task: "Long Run 8km", focus: "Cutback", actions: [{name: "Run 8km", desc: "Recharge", done: false}] },
            { week: 4, date: "Dec 14 (Sun)", task: "Walk 30min", focus: "Relax", actions: [{name: "Walk", desc: "", done: false}] },
            { week: 4, date: "Dec 15 (Mon)", task: "Rest", focus: "Recovery", actions: [{name: "Rest", desc: "", done: false}] },
            { week: 4, date: "Dec 16 (Tue)", task: "Easy Run 4km", focus: "Check", actions: [{name: "Run 4km", desc: "", done: false}] },
            { week: 4, date: "Dec 17 (Wed)", task: "Strength (Light)", focus: "Mobility", actions: [{name: "Air Squats", desc: "", done: false}, {name: "Clamshells", desc: "Bodyweight", done: false}] },
        ];

        let userPlan = [];
        let currentWeek = 1;
        let currentIndex = null;

        function init() {
            const storedData = JSON.parse(localStorage.getItem('marathonPlan_v3')) || [];
            userPlan = masterPlan.map((item, index) => {
                const saved = storedData[index];
                let mergedActions = item.actions.map(act => ({ ...act }));
                if (saved && saved.actions) {
                    mergedActions = item.actions.map((act, i) => {
                        if (saved.actions[i]) return { ...act, done: saved.actions[i].done };
                        return act;
                    });
                }
                return {
                    ...item,
                    actions: mergedActions,
                    result: saved ? saved.result : "",
                    feeling: saved ? saved.feeling : "",
                    pain: saved ? saved.pain : "",
                    done: saved ? saved.done : false
                };
            });
            render();
        }

        function changeWeek() {
            currentWeek = parseInt(document.getElementById('week-selector').value);
            render();
        }

        function render() {
            const list = document.getElementById('schedule-list');
            list.innerHTML = '';
            const weekTasks = userPlan.filter(item => item.week === currentWeek);
            const doneCount = weekTasks.filter(t => t.done).length;
            
            document.getElementById('progress-text').innerText = `${doneCount}/${weekTasks.length}`;
            document.getElementById('progress-bar').style.width = `${(doneCount/weekTasks.length)*100}%`;

            weekTasks.forEach((item) => {
                const realIndex = userPlan.indexOf(item);
                const statusClass = item.done ? 'bg-green-50 border-green-500 border-l-4' : 'bg-white border-l-4 border-blue-200';
                const icon = item.done ? '‚úÖ' : '‚≠ïÔ∏è';
                const painBadge = item.pain ? `<span class="ml-2 text-xs px-2 py-0.5 rounded ${item.pain > 2 ? 'bg-red-100 text-red-600' : 'bg-green-100 text-green-600'}">Pain:${item.pain}</span>` : '';
                
                const actionDone = item.actions.filter(a => a.done).length;
                const actionTotal = item.actions.length;
                const actionBadge = actionTotal > 0 ? `<span class="text-xs text-blue-600 bg-blue-50 px-1 rounded ml-1">Actions:${actionDone}/${actionTotal}</span>` : '';

                const html = `
                    <div onclick="openModal(${realIndex})" class="card cursor-pointer rounded-xl p-4 shadow-sm flex justify-between items-start mb-3 ${statusClass}">
                        <div class="flex-1">
                            <div class="flex justify-between items-center mb-1">
                                <span class="font-bold text-gray-800 text-sm">${item.date}</span>
                                ${painBadge}
                            </div>
                            <div class="font-bold text-gray-900 mb-1">${item.task}</div>
                            <p class="text-xs text-gray-500 mb-2">üí° ${item.focus} ${actionBadge}</p>
                            ${item.done ? `<div class="text-xs text-gray-700 mt-2 border-t border-gray-200 pt-2 bg-opacity-50">üìù ${item.result} <br>‚ù§Ô∏è ${item.feeling}</div>` : ''}
                        </div>
                        <div class="ml-3 text-xl mt-1">${icon}</div>
                    </div>
                `;
                list.innerHTML += html;
            });
        }

        function openModal(index) {
            currentIndex = index;
            const item = userPlan[index];
            document.getElementById('modal-title').innerText = item.task;
            document.getElementById('input-result').value = item.result;
            document.getElementById('input-feeling').value = item.feeling;
            selectPain(item.pain || 0);
            
            const actionList = document.getElementById('action-list');
            actionList.innerHTML = '';
            if (item.actions && item.actions.length > 0) {
                document.getElementById('action-section').classList.remove('hidden');
                item.actions.forEach((action, i) => {
                    const checkedClass = action.done ? 'checked' : 'bg-white border-gray-200';
                    const checkIcon = action.done ? '‚úì' : '';
                    const checkBg = action.done ? 'bg-green-500 border-green-500 text-white' : 'border-gray-300 bg-white';
                    
                    actionList.innerHTML += `
                        <div onclick="toggleAction(${i})" class="action-item ${checkedClass} cursor-pointer border rounded-lg p-3 flex items-start transition-colors duration-200 select-none">
                            <div class="check-box w-6 h-6 border rounded flex-shrink-0 flex items-center justify-center mr-3 mt-0.5 ${checkBg}">
                                ${checkIcon}
                            </div>
                            <div>
                                <div class="text-sm font-bold action-name">${action.name}</div>
                                <div class="text-xs text-gray-500 mt-1 leading-tight">${action.desc}</div>
                            </div>
                        </div>
                    `;
                });
            } else {
                document.getElementById('action-section').classList.add('hidden');
            }

            document.getElementById('modal').classList.remove('hidden');
        }

        function toggleAction(actionIndex) {
            const currentState = userPlan[currentIndex].actions[actionIndex].done;
            userPlan[currentIndex].actions[actionIndex].done = !currentState;
            openModal(currentIndex);
        }

        function closeModal() {
            document.getElementById('modal').classList.add('hidden');
        }

        function selectPain(level) {
            document.getElementById('input-pain').value = level;
            document.querySelectorAll('.pain-btn').forEach(btn => {
                btn.classList.remove('bg-blue-600', 'text-white', 'ring-2', 'ring-blue-300');
            });
            if(level !== "") {
                const btn = document.getElementById(`pain-btn-${level}`);
                if(btn) btn.classList.add('bg-blue-600', 'text-white', 'ring-2', 'ring-blue-300');
            }
        }

        function saveData() {
            const result = document.getElementById('input-result').value;
            const feeling = document.getElementById('input-feeling').value;
            const pain = document.getElementById('input-pain').value;
            const actionDone = userPlan[currentIndex].actions.some(a => a.done);

            if(!result && !feeling && !actionDone) { alert("Check an action or enter result."); return; }

            userPlan[currentIndex].result = result;
            userPlan[currentIndex].feeling = feeling;
            userPlan[currentIndex].pain = pain;
            userPlan[currentIndex].done = true;

            localStorage.setItem('marathonPlan_v3', JSON.stringify(userPlan));
            render();
            closeModal();
        }

        function backupToEmail() {
            const weekTasks = userPlan.filter(item => item.week === currentWeek && item.done);
            if(weekTasks.length === 0) { alert("No logs available."); return; }
            const subject = `üèÉ‚Äç‚ôÇÔ∏è Duck Feet Fix: Week ${currentWeek}`;
            let body = `Week ${currentWeek} Report\n\n`;
            weekTasks.forEach(item => {
                body += `„Äê${item.date}„Äë ${item.task}\n`;
                if(item.actions) {
                    const dones = item.actions.filter(a => a.done).map(a => `‚òëÔ∏è ${a.name}`).join('\n');
                    if(dones) body += `${dones}\n`;
                }
                body += `Result: ${item.result}\nFeeling: ${item.feeling} (Pain: ${item.pain})\n\n`;
            });
            window.location.href = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
        }

        function generateReport() {
            let report = `üèÉ‚Äç‚ôÇÔ∏è Report (Week ${currentWeek})\n\n`;
            const weekTasks = userPlan.filter(item => item.week === currentWeek && item.done);
            if(weekTasks.length === 0) { alert("No logs."); return; }
            weekTasks.forEach(item => {
                report += `üìÖ ${item.date}\nüìù ${item.result}\n‚ù§Ô∏è ${item.feeling} (Pain:${item.pain})\n\n`;
            });
            navigator.clipboard.writeText(report).then(() => alert("Copied!"));
        }

        init();
    </script>
</body>
</html>
